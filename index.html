<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WEB VISION - CORS Anywhere 利用版</title>
  <style>
    body { 
      font-family: sans-serif; 
      margin: 20px; 
    }
    input[type="text"] { 
      width: 300px; 
      padding: 6px; 
      font-size: 14px; 
    }
    button { 
      padding: 6px 12px; 
      font-size: 14px; 
    }
  </style>
</head>
<body>
  <div id="interface">
    <h1>WEB VISION</h1>
    <p>表示したい URL を入力してください：</p>
    <form id="urlForm">
      <input type="text" id="urlInput" placeholder="https://example.com" required>
      <button type="submit">表示</button>
    </form>
    <p>
      ※ この方式は、cors-anywhere (https://cors-anywhere.herokuapp.com/) を利用して CORS 制約を回避し、写真・動画などのリソースも正しく表示できるようにしています。
    </p>
  </div>

  <script>
    // URL パラメータ "url" の有無をチェック
    const params = new URLSearchParams(window.location.search);
    const targetUrl = params.get("url");

    if (targetUrl) {
      // URL 指定がある場合、取得中のメッセージを表示
      document.body.innerHTML = "<p>取得中...</p>";

      // cors-anywhere を利用して対象 URL のコンテンツを取得
      const proxyUrl = "https://cors-anywhere.herokuapp.com/";
      fetch(proxyUrl + targetUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error("ネットワークエラー: " + response.status);
          }
          return response.text();
        })
        .then(htmlText => {
          // 取得した HTML 内に <base> タグを挿入して相対パスの解決をサポート
          if (htmlText.match(/<head[^>]*>/i)) {
            htmlText = htmlText.replace(/<head([^>]*)>/i, `<head$1><base href="${targetUrl}">`);
          } else {
            htmlText = `<head><base href="${targetUrl}"></head>` + htmlText;
          }
          // 取得した HTML で現在のドキュメントを置き換え
          document.open();
          document.write(htmlText);
          document.close();
        })
        .catch(err => {
          document.body.innerHTML = "<p>エラー: " + err.message + "</p>";
        });
    } else {
      // 初期画面：URL 入力フォームの処理
      document.getElementById("urlForm").addEventListener("submit", function(e) {
        e.preventDefault();
        const url = document.getElementById("urlInput").value;
        // 同一ページに URL パラメータを付与してリダイレクト
        window.location.href = window.location.pathname + "?url=" + encodeURIComponent(url);
      });
    }
  </script>
</body>
</html>
