<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>webvision v2</title>
  <style>
    body {
      font-family: sans-serif;
    }
    #result {
      border: 1px solid #ccc;
      margin-top: 20px;
      padding: 10px;
    }
    .notice {
      color: red;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>URLプレビュー</h1>
  <p class="notice">
    使用する際は、必ず
    <a href="https://cors-anywhere.herokuapp.com/" target="_blank">
      https://cors-anywhere.herokuapp.com/
    </a>
    にアクセスしてください
  </p>
  <p>表示したいURLを入力してください（例: https://example.com）</p>
  <form id="urlForm">
    <input type="text" id="urlInput" placeholder="https://example.com" style="width:300px;" required>
    <button type="submit">取得する</button>
  </form>
  <hr>
  <div id="result"></div>

  <script>
    // プロキシURL（CORS回避用）
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
    const resultDiv = document.getElementById('result');

    // 指定したURLのコンテンツを取得し、表示領域に反映する関数
    async function loadPage(url) {
      resultDiv.innerHTML = '取得中...';
      try {
        const response = await fetch(proxyUrl + url);
        if (!response.ok) throw new Error('ネットワークエラーです');
        const htmlText = await response.text();

        // 取得したHTMLをパース
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlText, 'text/html');

        // 基準となるURLを作成
        const baseUrl = new URL(url);
        function toAbsolute(urlStr) {
          try {
            return new URL(urlStr, baseUrl).href;
          } catch (e) {
            return urlStr;
          }
        }

        // 画像のsrc属性を絶対パスに変換（data:スキームは除外）
        doc.querySelectorAll('img').forEach(img => {
          const src = img.getAttribute('src');
          if (src && !src.startsWith('http') && !src.startsWith('data:')) {
            img.setAttribute('src', toAbsolute(src));
          }
        });
        // CSSなどのリンク
        doc.querySelectorAll('link').forEach(link => {
          const href = link.getAttribute('href');
          if (href && !href.startsWith('http')) {
            link.setAttribute('href', toAbsolute(href));
          }
        });
        // スクリプトのsrc属性
        doc.querySelectorAll('script').forEach(script => {
          const src = script.getAttribute('src');
          if (src && !src.startsWith('http')) {
            script.setAttribute('src', toAbsolute(src));
          }
        });
        // iframeのsrc属性（YouTubeなどの埋め込み動画用）
        doc.querySelectorAll('iframe').forEach(iframe => {
          const src = iframe.getAttribute('src');
          if (src && !src.startsWith('http') && !src.startsWith('data:')) {
            iframe.setAttribute('src', toAbsolute(src));
          }
        });
        // aタグのhref属性を絶対パスに変換
        doc.querySelectorAll('a').forEach(a => {
          const href = a.getAttribute('href');
          if (href && !href.startsWith('http')) {
            a.setAttribute('href', toAbsolute(href));
          }
        });

        // 表示する際、全体のHTML構造を入れる（head部分も含むため、場合によってはレイアウトやスクリプトの競合に注意）
        resultDiv.innerHTML = doc.documentElement.innerHTML;
      } catch (err) {
        resultDiv.textContent = 'エラーが発生しました: ' + err.message;
      }
    }

    // フォーム送信時に初回URLを読み込む
    document.getElementById('urlForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const inputUrl = document.getElementById('urlInput').value;
      loadPage(inputUrl);
    });

    // 表示領域内のリンククリックを横取りして、プロキシ経由で新たに読み込む
    resultDiv.addEventListener('click', function(e) {
      const anchor = e.target.closest('a');
      if (anchor && anchor.href) {
        e.preventDefault();
        loadPage(anchor.href);
      }
    });
  </script>
</body>
</html>
