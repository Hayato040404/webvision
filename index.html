<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Web VISION V5</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #result {
      margin-top: 20px;
    }
    iframe {
      border: 1px solid #ccc;
      width: 100%;
      height: 80vh;
    }
    .notice {
      color: red;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>Web VISION V5</h1>
  <p class="notice">
 これは、ｗｅb制作者が自作したプロキシサーバーが含まれています。
  </p>
  <p>表示したいURLを入力してください（例: https://example.com）</p>
  <form id="urlForm">
    <input type="text" id="urlInput" placeholder="https://example.com" style="width:300px;" required>
    <button type="submit">取得する</button>
  </form>
  <div id="result"></div>

  <script>
    // Render にデプロイしたプロキシサーバーのエンドポイント（末尾に ?url= を付与）
    const proxyUrl = 'https://proxy-q3rg.onrender.com/proxy?url=';
    const resultDiv = document.getElementById('result');

    async function loadPage(url) {
      resultDiv.innerHTML = '取得中...';
      try {
        const response = await fetch(proxyUrl + encodeURIComponent(url));
        if (!response.ok) throw new Error('ネットワークエラーです');
        let htmlText = await response.text();

        // 相対URLの解決用に、取得した HTML 内の head に <base> タグを追加
        const baseUrl = new URL(url);
        const baseTag = '<base href="' + baseUrl.href + '">';
        if (htmlText.match(/<head[^>]*>/i)) {
          htmlText = htmlText.replace(/<head([^>]*)>/i, '<head$1>' + baseTag);
        } else {
          htmlText = '<head>' + baseTag + '</head>' + htmlText;
        }

        // iframe を作成し、取得した HTML を読み込む
        const iframe = document.createElement('iframe');
        resultDiv.innerHTML = '';
        resultDiv.appendChild(iframe);
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(htmlText);
        iframeDoc.close();

        // iframe 内のリンクやフォーム送信も横取りしてプロキシ経由にする
        setupIframeInterception(iframeDoc);
      } catch (err) {
        resultDiv.textContent = 'エラーが発生しました: ' + err.message;
      }
    }

    // iframe 内のリンクやフォーム送信を横取りする処理
    function setupIframeInterception(doc) {
      // すべてのリンクの target 属性を削除し、クリック時に loadPage を呼ぶ
      const anchors = doc.querySelectorAll('a');
      anchors.forEach(anchor => {
        anchor.removeAttribute('target');
        anchor.addEventListener('click', function(e) {
          e.preventDefault();
          const href = anchor.href;
          if (href) {
            loadPage(href);
          }
        });
      });
      
      // GET メソッドのフォーム送信を横取り
      const forms = doc.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          let action = form.action || doc.location.href;
          const method = (form.method || 'get').toLowerCase();
          if (method === 'get') {
            const formData = new FormData(form);
            const queryString = new URLSearchParams(formData).toString();
            if (queryString) {
              action += (action.includes('?') ? '&' : '?') + queryString;
            }
            loadPage(action);
          }
          // POST の場合は追加実装が必要
        });
      });
    }

    // フォーム送信で初回ページ読み込み
    document.getElementById('urlForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const inputUrl = document.getElementById('urlInput').value;
      loadPage(inputUrl);
    });
  </script>
</body>
</html>
